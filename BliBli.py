# -*- coding=utf8 -*-import jsonimport osimport reimport sysimport requestsfrom tqdm import  tqdmfrom lxml import etreedef parse_url(url):    json_data = requests.get(url,headers=headers).json()    video_list = []    for video  in  json_data["result"]['video'][:6]:        video_dic = {}        video_dic['title']  = video.get('title').replace(r'/','_')        video_dic['id'] = video.get('id')        video_list.append(video_dic)    # id_list =[url.split('av')[1].split('?')[0] for url in  html.xpath("//div[@class='video-item']/div[@class='info']/a[@class='blue']/@href")]    get_url = "https://www.kanbilibili.com/api/video/{}/download?cid={}&quality=48&page=1"    for video in video_list:        js_ =  requests.get("https://www.kanbilibili.com/video/av{}?from=ksearch".format(video['id'])).text        cid =  re.findall(r'cid":(\d+),',js_)[0]        res = requests.get(get_url.format(video['id'],cid),headers=headers).json()        video_url = res['data'].get('durl')        size =  res['data'].get('durl')[0]['size']        if video_url != None:            video_url = video_url[0]['url']        download(video_url,video['title'],size)        # 解析def download(video_url,title,size):    print("下载文件:%s, 文件大小:%.2fM"%(title,size/1024/1024))    res = requests.get(video_url,headers=headers,stream=True) #stream参数读取大文件    chunk_size = 1024    if res.status_code == 200 :        base_dir = sys.path[0]        dir_path =  os.path.join(base_dir,'dowload')        if  not os.path.exists(dir_path) :            os.mkdir(dir_path)        file_path = os.path.join(dir_path,title)        file_size = int(res.headers['content-length'])        if not os.path.exists(file_path):            with open(r'{}'.format(file_path)+'.mp4',mode='wb') as f :                print('开始下载')                size_ = 0                pbar = tqdm(total=file_size,unit='B',unit_scale=True,desc=title)                for stream in res.iter_content(chunk_size=chunk_size):  # 切分视频流                    f.write(stream)                    size_ += len(stream)                    pbar.update(1024)                    # f.flush()  # 一次write后需要flush                    # '\r'使每一次print会覆盖前一个print信息，end=''使print不换行，如果全部保存完，print再换行                    # 实现下载进度实时刷新，当保存到100%时，打印下一行                    # print('下载进度:%.2f%%' % float(size_ /size * 100) + '\r',                    #       end='' if (size / size_) != 1 else '\n')                pbar.close()                print('下载完成..')    else:        print("下载失败..")if __name__ == '__main__':    keyword_list  = "幸福来敲门,蜗居,媳妇的美好时代,梅花三弄,花开半夏,因为爱情有多美,山楂树之恋,零号特工,黑玫瑰,妈妈的花样年华,咱们结婚吧,婆婆来了,妯娌的三国时代,皮五传奇,十大奇冤,蜗居,亮剑,雪豹,我的青春谁做主,家的n次方,北京爱情,妻子的诱惑,模仿韩剧拍的,媳妇的美好时代,门第,千金归来,独生子女的婆婆妈妈,辣妈正传,金太郎的幸福生活,金粉世家,乱世佳人,烽火佳人,王贵与安娜,憨媳当家,咱们结婚吧,妯娌的三国时代,媳妇的美好时代,岳母的幸福生活,我的极品老妈,婆婆来了,双城生活,断奶,媳妇的美好宣言,天真遇到现实,先结婚后恋爱,租个女友回家过年,野鸭子,独生子女的婆婆妈妈,裸婚时代,亮剑,雪豹,黑狐,苍狼,战旗,中国骑兵,永不磨灭的番号,我的青春谁做主,家的n次方,辣妈正传,金太郎的幸福生活,北京爱情故事,民兵葛二蛋,老有所依,养父,美丽的契约,老妈的三国时代".split(',')    headers = {        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36',    }    for keyword in keyword_list:        base_url = 'https://www.kanbilibili.com/api/search?keyword={}&order=default&page=1'.format(keyword)        print(keyword,base_url)        parse_url(base_url)